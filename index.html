<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocketChat</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #3f3f3f;
        }
        .panel-bg {
            background-color: #2f2f2f;
        }
        .request-item:hover, .message-item:hover {
            background-color: #3b3b3b;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            z-index: 999;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        /* Style the scrollbars */
        .overflow-y-auto::-webkit-scrollbar {
            width: 8px;
        }
        .overflow-y-auto::-webkit-scrollbar-thumb {
            background-color: #4b5563; /* Gray-600 */
            border-radius: 4px;
        }
        .overflow-y-auto::-webkit-scrollbar-track {
            background-color: #1f2937; /* Gray-800 */
        }
    </style>
</head>
<body class="text-gray-100 flex items-center justify-center min-h-screen p-4">

    <!-- Custom message box for alerts -->
    <div id="custom-message-box" class="hidden modal-overlay">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl border border-gray-700 w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4 text-white">Alert</h3>
            <p id="message-text" class="text-gray-300 mb-6"></p>
            <div class="flex justify-end">
                <button id="close-message-box" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-200">
                    OK
                </button>
            </div>
        </div>
    </div>
    
    <!-- Feature Request Modal -->
    <div id="feature-request-modal" class="hidden modal-overlay">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl border border-gray-700 w-full max-w-lg">
            <h3 class="text-xl font-bold mb-4 text-white">Submit a Feature Request</h3>
            <textarea id="feature-request-input" rows="4" placeholder="Describe the feature you would like to see..." class="w-full p-3 rounded-lg border border-gray-600 bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200 text-white mb-4"></textarea>
            <div class="flex justify-end space-x-2">
                <button id="cancel-request-button" class="px-4 py-2 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-700 transition duration-200">
                    Cancel
                </button>
                <button id="submit-request-button" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition duration-200">
                    Submit
                </button>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="name-modal" class="modal-overlay">
        <div class="panel-bg rounded-xl shadow-2xl p-6 w-full max-w-sm relative">
            <h1 class="text-3xl font-extrabold text-center mb-4 text-white">WebSocketChat</h1>
            
            <p class="text-gray-300 text-center mb-4">Please enter your username to join.</p>
            <input type="text" id="username-input" placeholder="Choose a username..." class="w-full p-3 rounded-lg border border-gray-600 bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200 text-white mb-2" autocomplete="off">
            <button id="join-chat-button" class="w-full p-3 text-white font-bold rounded-lg bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 transition duration-200">
                Join Chat
            </button>
            
            <div class="flex items-center justify-between my-4">
                <hr class="flex-grow border-gray-600">
                <span class="px-3 text-gray-400 font-bold">OR</span>
                <hr class="flex-grow border-gray-600">
            </div>

            <p class="text-gray-300 text-center mb-2">Admin Login</p>
            <input type="password" id="admin-password-input" placeholder="Admin Password" class="w-full p-3 rounded-lg border border-gray-600 bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200 text-white mb-2" autocomplete="off">
            <button id="admin-login-button" class="w-full p-3 text-white font-bold rounded-lg bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50 transition duration-200">
                Admin Login
            </button>
        </div>
    </div>

    <!-- User Chat Panel -->
    <div id="user-chat-panel" class="panel-bg hidden w-full h-[90vh] max-w-4xl mx-auto p-6 rounded-xl shadow-2xl grid grid-cols-1 md:grid-cols-3 gap-6">

        <!-- Left Sidebar: Connected Users & Admin Login -->
        <div class="col-span-1 flex flex-col space-y-6">
            <div class="flex items-center justify-between">
                <h2 class="text-xl font-bold">Connected Users</h2>
                <button id="admin-panel-toggle-btn" class="hidden px-3 py-1 text-white text-sm font-bold rounded-lg bg-red-600 hover:bg-red-700 transition duration-200">
                    Admin Panel
                </button>
            </div>
            
            <div id="users-list" class="panel-bg flex-grow overflow-y-auto p-2 rounded-xl border border-gray-600">
                <!-- Connected users will be injected here -->
            </div>
            
            <div class="flex-grow"></div> <!-- Spacer to push elements to the bottom -->

            <!-- User Actions Section -->
            <div class="flex flex-col space-y-2">
                <div class="flex items-center justify-between">
                    <span id="current-user" class="text-sm font-medium text-gray-400"></span>
                    <button id="feature-request-button" class="px-3 py-1 text-white text-sm font-bold rounded-lg bg-blue-600 hover:bg-blue-700 transition duration-200">
                        Feature Request
                    </button>
                </div>
                <div class="flex justify-end">
                    <button id="leave-button" class="px-3 py-1 text-white text-sm font-bold rounded-lg bg-red-600 hover:bg-red-700 transition duration-200">
                        Leave Chat
                    </button>
                </div>
            </div>
        </div>

        <!-- Right Column: Chat Display and Input -->
        <div class="col-span-1 md:col-span-2 flex flex-col">
            <h1 class="text-2xl font-extrabold mb-4">WebSocketChat</h1>
            <!-- Chat messages container -->
            <div id="chat-container" class="panel-bg flex-grow overflow-y-auto p-4 rounded-xl border border-gray-600 mb-4">
                <!-- Messages will be injected here -->
            </div>
            <!-- Message input form -->
            <form id="message-form" class="flex items-center space-x-2">
                <input type="text" id="message-input" placeholder="Type a message..." class="flex-grow p-3 rounded-lg border border-gray-600 bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200 text-white" autocomplete="off">
                <button type="button" id="send-button" class="p-3 text-white font-bold rounded-lg bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 transition duration-200">
                    Send
                </button>
            </form>
        </div>
    </div>

    <!-- Moderator Panel -->
    <div id="moderator-panel" class="panel-bg hidden w-full h-[90vh] max-w-4xl mx-auto p-6 rounded-xl shadow-2xl grid grid-cols-1 md:grid-cols-2 gap-6">

        <!-- Left Column: User and Ban Controls -->
        <div id="mod-control-panel" class="col-span-1 flex flex-col space-y-4">
            <div class="flex items-center justify-between">
                <h1 class="text-2xl font-extrabold">Moderator Panel</h1>
                <div class="flex items-center space-x-2">
                    <button id="admin-chat-toggle-btn" class="px-3 py-1 text-white text-sm font-bold rounded-lg bg-blue-600 hover:bg-blue-700 transition duration-200">
                        Admin Chat
                    </button>
                    <span id="mod-logged-in-as" class="text-sm font-medium text-gray-400"></span>
                    <button id="mod-leave-button" class="px-3 py-1 text-white text-sm font-bold rounded-lg bg-red-600 hover:bg-red-700 transition duration-200">
                        Logout
                    </button>
                </div>
            </div>
            
            <div class="flex flex-col flex-grow">
                <h3 class="text-lg font-semibold text-gray-300">Connected Users</h3>
                <div id="mod-connected-users-list" class="panel-bg overflow-y-auto p-2 rounded-xl border border-gray-600 mb-4 h-1/2">
                    <!-- Connected users with Ban button -->
                </div>
                <h3 class="text-lg font-semibold text-gray-300">Banned Users</h3>
                <div id="mod-banned-users-list" class="panel-bg overflow-y-auto p-2 rounded-xl border border-gray-600 h-1/2">
                    <!-- Banned users with Unban button -->
                </div>
            </div>
        </div>

        <!-- Right Column: Feature Requests Inbox -->
        <div class="col-span-1 flex flex-col" id="mod-feature-requests-panel">
            <h2 class="text-2xl font-extrabold text-white mb-4">Feature Requests Inbox</h2>
            <div id="mod-feature-requests-list" class="panel-bg flex-grow overflow-y-auto p-4 rounded-xl border border-gray-600">
                <!-- Feature requests will be injected here -->
            </div>
        </div>

        <!-- Admin Chat Panel -->
        <div id="admin-chat-panel" class="col-span-2 flex flex-col hidden">
            <div class="flex items-center justify-between mb-4">
                <h1 class="text-2xl font-extrabold text-white">Admin Chat</h1>
                <div class="flex items-center space-x-2">
                    <button id="admin-back-to-mod-panel" class="px-3 py-1 text-white text-sm font-bold rounded-lg bg-blue-600 hover:bg-blue-700 transition duration-200">
                        Back to Moderator Panel
                    </button>
                    <button id="admin-chat-leave-button" class="px-3 py-1 text-white text-sm font-bold rounded-lg bg-red-600 hover:bg-red-700 transition duration-200">
                        Logout
                    </button>
                </div>
            </div>
            <div id="admin-chat-container" class="panel-bg flex-grow overflow-y-auto p-4 rounded-xl border border-gray-600 mb-4">
                <!-- Admin chat messages will be injected here -->
            </div>
            <form id="admin-message-form" class="flex items-center space-x-2">
                <input type="text" id="admin-message-input" placeholder="Type a message as ADMIN..." class="flex-grow p-3 rounded-lg border border-gray-600 bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200 text-white" autocomplete="off">
                <button type="button" id="admin-send-button" class="p-3 text-white font-bold rounded-lg bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 transition duration-200">
                    Send
                </button>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- WebSocket URL ---
            // The URL for the WebSocket. If using playit.gg, you must replace 'localhost'
            // with the public URL playit.gg provides (e.g., 'wss://your-subdomain.playit.gg')
            const websocketUrl = 'ws://localhost:8080';

            // --- UI Elements ---
            const usernameInput = document.getElementById('username-input');
            const joinChatButton = document.getElementById('join-chat-button');
            const adminLoginButton = document.getElementById('admin-login-button');
            const adminPasswordInput = document.getElementById('admin-password-input');
            const nameModal = document.getElementById('name-modal');
            const userChatPanel = document.getElementById('user-chat-panel');
            const moderatorPanel = document.getElementById('moderator-panel');
            const currentUserSpan = document.getElementById('current-user');
            const messageInput = document.getElementById('message-input');
            const sendButton = document.getElementById('send-button');
            const chatContainer = document.getElementById('chat-container');
            const leaveButton = document.getElementById('leave-button');
            const adminPanelToggleBtn = document.getElementById('admin-panel-toggle-btn');
            const featureRequestButton = document.getElementById('feature-request-button');
            const usersList = document.getElementById('users-list');
            
            const modLoggedInAs = document.getElementById('mod-logged-in-as');
            const modLeaveButton = document.getElementById('mod-leave-button');
            const modConnectedUsersList = document.getElementById('mod-connected-users-list');
            const modBannedUsersList = document.getElementById('mod-banned-users-list');
            const adminChatToggleBtn = document.getElementById('admin-chat-toggle-btn');
            const modControlPanel = document.getElementById('mod-control-panel');
            const modFeatureRequestsPanel = document.getElementById('mod-feature-requests-panel');
            const adminChatPanel = document.getElementById('admin-chat-panel');
            const adminBackToModPanelBtn = document.getElementById('admin-back-to-mod-panel');
            const modFeatureRequestsList = document.getElementById('mod-feature-requests-list');
            const adminMessageInput = document.getElementById('admin-message-input');
            const adminSendButton = document.getElementById('admin-send-button');
            const adminChatContainer = document.getElementById('admin-chat-container');
            const adminChatLeaveButton = document.getElementById('admin-chat-leave-button');

            // Custom message box for alerts
            const customMessageBox = document.getElementById('custom-message-box');
            const messageText = document.getElementById('message-text');
            const closeMessageBoxButton = document.getElementById('close-message-box');

            // Feature request modal
            const featureRequestModal = document.getElementById('feature-request-modal');
            const featureRequestInput = document.getElementById('feature-request-input');
            const submitRequestButton = document.getElementById('submit-request-button');
            const cancelRequestButton = document.getElementById('cancel-request-button');

            // --- State Management ---
            let ws;
            let currentUser = null;
            let isBanned = false;
            let isConnected = false;
            
            // --- Helper Functions ---
            const showMessageBox = (message) => {
                messageText.textContent = message;
                customMessageBox.classList.remove('hidden');
            };

            closeMessageBoxButton.addEventListener('click', () => {
                customMessageBox.classList.add('hidden');
            });

            const renderMessage = (message, container, selfId) => {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('flex', 'flex-col', 'p-2', 'my-2', 'rounded-lg', 'shadow-md', 'break-words', 'message-item');
                
                if (message.userId === selfId) {
                    messageDiv.classList.add('bg-blue-600', 'self-end', 'ml-auto', 'max-w-md');
                } else {
                    messageDiv.classList.add('bg-gray-600', 'self-start', 'mr-auto', 'max-w-md');
                }
                
                const timestamp = new Date(message.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                messageDiv.innerHTML = `
                    <div class="flex items-center mb-1">
                        <span class="font-bold text-sm text-gray-100">${message.userName}</span>
                        <span class="text-xs text-gray-300 ml-2">${timestamp}</span>
                    </div>
                    <p class="text-sm text-gray-100">${message.text}</p>
                `;
                container.appendChild(messageDiv);
                container.scrollTop = container.scrollHeight;
            };

            const renderUser = (user, type = 'connected') => {
                const userDiv = document.createElement('div');
                userDiv.classList.add('flex', 'items-center', 'justify-between', 'p-2', 'rounded-lg', 'my-1', 'border', 'border-gray-600');
                userDiv.innerHTML = `
                    <div class="flex flex-col">
                        <span class="text-sm font-semibold text-gray-200">${user.name}</span>
                        <span class="text-xs text-gray-400 truncate w-32 md:w-full">ID: ${user.id}</span>
                    </div>
                `;
                
                const actionButton = document.createElement('button');
                actionButton.classList.add('px-3', 'py-1', 'text-white', 'text-xs', 'font-bold', 'rounded-lg', 'transition', 'duration-200');
                
                if (type === 'connected') {
                    actionButton.textContent = 'Ban';
                    actionButton.classList.add('bg-red-600', 'hover:bg-red-700');
                    actionButton.addEventListener('click', () => {
                        ws.send(JSON.stringify({ type: 'banUser', userId: user.id }));
                    });
                } else if (type === 'banned') {
                    actionButton.textContent = 'Unban';
                    actionButton.classList.add('bg-green-600', 'hover:bg-green-700');
                    actionButton.addEventListener('click', () => {
                        ws.send(JSON.stringify({ type: 'unbanUser', userId: user.id }));
                    });
                }

                // Only show button if user is not the current user
                if (currentUser && user.id !== currentUser.id) {
                    userDiv.appendChild(actionButton);
                }
                
                return userDiv;
            };

            const togglePanel = (panelName) => {
                // Hide all main panels by default
                userChatPanel.classList.add('hidden');
                moderatorPanel.classList.add('hidden');
                adminChatPanel.classList.add('hidden');
                nameModal.classList.add('hidden');
                adminPanelToggleBtn.classList.add('hidden');

                if (panelName === 'mod') {
                    // Show moderator panel and its sub-panels
                    moderatorPanel.classList.remove('hidden');
                    modControlPanel.classList.remove('hidden');
                    modFeatureRequestsPanel.classList.remove('hidden');
                    adminChatPanel.classList.add('hidden');
                    modLoggedInAs.textContent = `Logged in as: ${currentUser.name}`;
                } else if (panelName === 'chat') {
                    userChatPanel.classList.remove('hidden');
                    // Only show the admin panel toggle button if the user is an admin
                    if (currentUser && currentUser.isAdmin) {
                        adminPanelToggleBtn.classList.remove('hidden');
                    }
                    currentUserSpan.textContent = `You are: ${currentUser.name}`;
                } else if (panelName === 'admin-chat') {
                    // Show the admin chat, but hide the moderator control sub-panels
                    moderatorPanel.classList.remove('hidden');
                    modControlPanel.classList.add('hidden');
                    modFeatureRequestsPanel.classList.add('hidden');
                    adminChatPanel.classList.remove('hidden');
                } else {
                     nameModal.classList.remove('hidden');
                }
            };
            
            const leave = () => {
                if (ws && isConnected) {
                    ws.close();
                    isConnected = false;
                }
                togglePanel('login');
                currentUser = null;
                isBanned = false;
                usernameInput.value = '';
                adminPasswordInput.value = '';
                chatContainer.innerHTML = '';
                usersList.innerHTML = '';
                modConnectedUsersList.innerHTML = '';
                modBannedUsersList.innerHTML = '';
                modFeatureRequestsList.innerHTML = '';
                showMessageBox('You have left the chat.');
            };

            // --- WebSocket Connection ---
            const connectWebSocket = (userName, password) => {
                ws = new WebSocket(websocketUrl);

                ws.onopen = () => {
                    console.log('Connected to WebSocket server');
                    ws.send(JSON.stringify({ type: 'join', userName, password }));
                    isConnected = true;
                    showMessageBox('Successfully connected to the chat.');
                };

                ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    
                    switch (data.type) {
                        case 'joinSuccess':
                            currentUser = data.user;
                            nameModal.classList.add('hidden');
                            if (currentUser.isAdmin) {
                                togglePanel('mod');
                            } else {
                                togglePanel('chat');
                            }
                            break;
                        case 'chatHistory':
                            chatContainer.innerHTML = '';
                            adminChatContainer.innerHTML = '';
                            data.messages.forEach(message => {
                                renderMessage(message, chatContainer, currentUser ? currentUser.id : null);
                                renderMessage(message, adminChatContainer, currentUser ? currentUser.id : null);
                            });
                            chatContainer.scrollTop = chatContainer.scrollHeight;
                            adminChatContainer.scrollTop = adminChatContainer.scrollHeight;
                            break;
                        case 'newMessage':
                            renderMessage(data.message, chatContainer, currentUser ? currentUser.id : null);
                            renderMessage(data.message, adminChatContainer, currentUser ? currentUser.id : null);
                            chatContainer.scrollTop = chatContainer.scrollHeight;
                            adminChatContainer.scrollTop = adminChatContainer.scrollHeight;
                            break;
                        case 'updateUserLists':
                            usersList.innerHTML = '';
                            modConnectedUsersList.innerHTML = '';
                            modBannedUsersList.innerHTML = '';
                            
                            const connectedUsers = data.connectedUsers || [];
                            const bannedUsers = data.bannedUsers || [];
                            
                            connectedUsers.forEach(user => {
                                const userItem = document.createElement('div');
                                userItem.className = 'flex items-center space-x-2 p-2 rounded-lg my-1';
                                userItem.innerHTML = `<div class="w-2 h-2 rounded-full bg-green-500"></div><span class="text-sm font-medium">${user.name}</span>`;
                                usersList.appendChild(userItem);
                                
                                if (currentUser && currentUser.isAdmin) {
                                    modConnectedUsersList.appendChild(renderUser(user, 'connected'));
                                }
                            });
                            
                            bannedUsers.forEach(user => {
                                if (currentUser && currentUser.isAdmin) {
                                    modBannedUsersList.appendChild(renderUser(user, 'banned'));
                                }
                            });
                            break;
                        case 'updateFeatureRequests':
                            if (currentUser && currentUser.isAdmin) {
                                modFeatureRequestsList.innerHTML = '';
                                data.requests.forEach(request => {
                                    const requestItem = document.createElement('div');
                                    requestItem.className = 'bg-gray-700 p-3 rounded-lg mb-2 flex justify-between items-start request-item';
                                    
                                    const contentDiv = document.createElement('div');
                                    contentDiv.className = 'flex-grow';
                                    
                                    const timestamp = new Date(request.timestamp).toLocaleDateString([], { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                                    contentDiv.innerHTML = `
                                        <div class="flex items-center justify-between">
                                            <span class="font-semibold text-gray-200">${request.userName}</span>
                                            <span class="text-xs text-gray-400">${timestamp}</span>
                                        </div>
                                        <p class="text-gray-300 mt-2">${request.text}</p>
                                    `;

                                    const deleteButton = document.createElement('button');
                                    deleteButton.className = 'p-1 rounded-lg text-white bg-red-600 hover:bg-red-700 transition duration-200 ml-4';
                                    deleteButton.innerHTML = `
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 112 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                                        </svg>
                                    `;
                                    deleteButton.addEventListener('click', () => {
                                        if (confirm('Are you sure you want to delete this feature request?')) {
                                             ws.send(JSON.stringify({ type: 'deleteFeatureRequest', requestId: request.id }));
                                        }
                                    });

                                    requestItem.appendChild(contentDiv);
                                    requestItem.appendChild(deleteButton);
                                    modFeatureRequestsList.appendChild(requestItem);
                                });
                            }
                            break;
                        case 'banned':
                            isBanned = true;
                            showMessageBox("You have been banned from the chat.");
                            leave();
                            break;
                        case 'alert':
                            showMessageBox(data.message);
                            break;
                    }
                };

                ws.onclose = () => {
                    console.log('Disconnected from WebSocket server');
                    if (isConnected) {
                        showMessageBox("Disconnected from the chat server. Please refresh to reconnect.");
                    }
                    isConnected = false;
                };

                ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    if (isConnected) {
                        showMessageBox("An error occurred with the chat connection.");
                    }
                    isConnected = false;
                };
            };

            const sendMessage = (text, container) => {
                if (text.trim() === '') return;
                if (!ws || ws.readyState !== WebSocket.OPEN || isBanned) {
                    showMessageBox('You cannot send messages at this time.');
                    return;
                }
                ws.send(JSON.stringify({ type: 'chatMessage', text: text }));
                container.value = '';
            };
            
            // --- Event Listeners ---
            joinChatButton.addEventListener('click', () => {
                const userName = usernameInput.value.trim();
                if (!userName) {
                    showMessageBox("Please enter a username to join.");
                    return;
                }
                if (userName.toUpperCase() === 'ADMIN') {
                    showMessageBox("The username 'ADMIN' is reserved for admin login.");
                    return;
                }
                connectWebSocket(userName, '');
            });

            adminLoginButton.addEventListener('click', () => {
                const password = adminPasswordInput.value;
                if (!password) {
                    showMessageBox("Please enter the admin password.");
                    return;
                }
                connectWebSocket('ADMIN', password);
            });
            
            sendButton.addEventListener('click', () => sendMessage(messageInput.value, messageInput));
            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    sendMessage(messageInput.value, messageInput);
                }
            });

            adminSendButton.addEventListener('click', () => sendMessage(adminMessageInput.value, adminMessageInput));
            adminMessageInput.addEventListener('keypress', (e) => {
                 if (e.key === 'Enter') {
                    e.preventDefault();
                    sendMessage(adminMessageInput.value, adminMessageInput);
                }
            });

            leaveButton.addEventListener('click', leave);
            modLeaveButton.addEventListener('click', leave);
            adminChatLeaveButton.addEventListener('click', leave);

            adminPanelToggleBtn.addEventListener('click', () => togglePanel('mod'));
            adminChatToggleBtn.addEventListener('click', () => togglePanel('admin-chat'));
            adminBackToModPanelBtn.addEventListener('click', () => togglePanel('mod'));

            featureRequestButton.addEventListener('click', () => {
                featureRequestModal.classList.remove('hidden');
            });
            cancelRequestButton.addEventListener('click', () => {
                featureRequestModal.classList.add('hidden');
                featureRequestInput.value = '';
            });
            submitRequestButton.addEventListener('click', () => {
                const requestText = featureRequestInput.value.trim();
                if (requestText) {
                    if (ws && ws.readyState === WebSocket.OPEN && currentUser) {
                        ws.send(JSON.stringify({ type: 'featureRequest', text: requestText }));
                        featureRequestModal.classList.add('hidden');
                        featureRequestInput.value = '';
                        showMessageBox('Your feature request has been submitted!');
                    } else {
                        showMessageBox('Connection lost. Please reconnect and try again.');
                    }
                } else {
                    showMessageBox('Please enter a description for your feature request.');
                }
            });
        });
    </script>
</body>
</html>
